const { 
    isItUp,
    checkHeaders,
    outDated,
    pathTraversalCheck,
    checkSQLi,

} = require('./standAloneController');
const scrape = require('../utils/puppeteerUtils');
const chainAll = require('../utils/vulnerabilitiesUtils/chainUtils');

// Controller for scan
const scan = async (req, res) => {
    // Result object
    let scanResult = {};

    // Checking if the site is up
    const url = req.body.url;
    console.log(`URL: ${url}`);

    // Get the data about the webpage
    global.scrapedData = await scrape(url);
    // Add URL
    scanResult['website'] = url;
    const options = {
        responseCode: true
    };

    try {
        // Check site response code
        const up = await isItUp(url);
        if (!up) {
            res.status(400).send( { error: "Site is not up!" } )
        }

        // Check for security headers
        scanResult['missingHeaders'] = await checkHeaders(url);
        console.log(`Missing Headers: ${scanResult['missingHeaders']}`);

        // Check for outdated
        scanResult['outDated'] = await outDated(url);
        
        // Check for path traversal
        scanResult['pathTraversal'] = await pathTraversalCheck(url);

        // Check for myql vulnerability
        scanResult['SQLi'] = await checkSQLi(url);

        // chain All
        const chained = await chainAll(scanResult);

        // Send the final scan result
        console.log("Result:", scanResult);
        return res.status(200).send({ result : scanResult });
    } catch (error) {
        console.error('Error:', error);
        return res.status(500).send({ error: "Internal Server Error" });
    }
};

module.exports = {
    scan
}